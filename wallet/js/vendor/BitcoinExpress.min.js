var frame_id="walletxyz",BitcoinExpress={BitcoinExpress:"v1.0.0",wellKnownWallets:JSON.parse('[{"domain":"bitcoin-e.org","protocol":"https://","port":":443","path":"","probe":"/wallet/probe.html","wallet":"/wallet/wallet.html"}]'),Initialise:function(){void 0,"B_E"in window?($("div#B_E_container").remove(),$("iframe.wallet").remove()):(window.B_E=window.BitcoinExpress,void 0)},Wallet:{Dimentions:{WalletWindow:null,WalletWidth:null,WalletHeight:null,WalletArea:null,WalletLastPosition:{top:0,left:0}},Open:function(e){return e||(e={}),BitcoinExpress.Initialise(),B_E._.getWalletDomain().then(function(t){return B_E._.startWallet(t,e)})},PaymentRequest:function(e,t,n){return BitcoinExpress.Initialise(),B_E._.getPaymentRequest(e,t,n).then(function(e){return B_E._.getWalletDomain()}).then(function(e){return B_E._.startWallet(e,paymentRequest)})}},_:{startWallet:function(e,t){void 0,$("body").append("<div id='B_E_container'/>");var n=e;this.isDraggable=!1,this.activeDraggable=!1,this.isModal=!1,this.frame_id=frame_id;var o=this;n+="?fullScreen="+("fullScreen"in t&&t.fullScreen);var i=null;if("PaymentRequest"in t){var s=t.PaymentRequest;if(n+="&paymentRequest="+encodeURI(JSON.stringify(t.PaymentRequest)),"PaymentDetails"in s&&"payment_url"in s.PaymentDetails&&(i=s.PaymentDetails.payment_url),null===i)return Promise.reject(new Error("PaymentRequest has no payment_url"))}return $("<iframe>",{src:n,id:"walletxyz",class:"wallet",frameborder:0,scrolling:"no",style:"z-index: 10000000; display: hidden;"}).appendTo("body"),new Promise(function(e,t){var n=function(e){var s=e.data;"bubble_up_mousemove"!==s.fn&&(void 0,void 0);function r(e){window.addEventListener&&window.addEventListener("DOMMouseScroll",B_E._.preventDefault,!1),window.onwheel=B_E._.preventDefault,window.onmousewheel=document.onmousewheel=B_E._.preventDefault,window.ontouchmove=B_E._.preventDefault,document.onkeydown=B_E._.preventDefaultForScrollKeys,document.getElementsByTagName("body")[0].style.overflow="hidden"}function a(){window.removeEventListener&&window.removeEventListener("DOMMouseScroll",B_E._.preventDefault,!1),window.onmousewheel=document.onmousewheel=null,window.onwheel=null,window.ontouchmove=null,document.onkeydown=null,document.getElementsByTagName("body")[0].style.overflow="scroll"}switch(s.fn){case"bubble_up_mousemove":if(!o.dragging)break;var l=document.getElementById(s.frameId),c=s.screenX-o.x_elem,d=s.screenY-o.y_elem;l.style.left=c+document.documentElement.scrollLeft+"px",l.style.top=d+document.documentElement.scrollTop+"px";break;case"bubble_up_mouseup":l=document.getElementById(s.frameId);B_E.Wallet.WalletLastPosition={top:l.offsetTop,left:l.offsetLeft},o.dragging=!1;break;case"disable_scroll":r(s.hide);break;case"enable_scroll":a();break;case"show_iframe":B_E._.show_iframe(frame_id,null,!0,null);break;case"hide_iframe":B_E._.show_iframe(frame_id,null,!1,null);break;case"gomodal_iframe":if(o.isModal=s.goModal,s.goModal){var m=B_E.Wallet.WalletLastPosition||{left:0,top:0},u=document.documentElement,f=(window.pageXOffset||u.scrollLeft)-(u.clientLeft||0),p=(window.pageYOffset||u.scrollTop)-(u.clientTop||0);B_E._.resize_iframe(frame_id,window.innerWidth,window.innerHeight),B_E._.move_iframe(frame_id,p,f),o.isDraggable&&r()}else{m=B_E.Wallet.WalletLastPosition||{left:0,top:0};B_E._.resize_iframe(frame_id,s.width,s.height),B_E._.move_iframe(frame_id,m.top,m.left),o.isDraggable&&a()}if(s.walletId){u=document.documentElement;var g=B_E.Wallet.WalletLastPosition||{left:0,top:0},_=(window.pageXOffset||u.scrollLeft)-(u.clientLeft||0),w=(window.pageYOffset||u.scrollTop)-(u.clientTop||0);e.source.postMessage({fn:"relocateWallet",left:g.left-_,top:g.top-w,walletId:s.walletId},"*")}break;case"resize_iframe":if(s.fullScreen){o.isDraggable=!1;var v=o.get_window_size();B_E._.resize_iframe(frame_id,v.width,v.height);u=document.documentElement,f=(window.pageXOffset||u.scrollLeft)-(u.clientLeft||0),p=(window.pageYOffset||u.scrollTop)-(u.clientTop||0);B_E._.move_iframe(frame_id,p,f)}else{o.isDraggable=!0,B_E._.resize_iframe(frame_id,s.width,s.height);(m=B_E.Wallet.WalletLastPosition)&&"top"in m&&"left"in m&&B_E._.move_iframe(frame_id,m.top,m.left)}break;case"start_drag_iframe":if(!o.isDraggable)break;B_E._.start_drag_iframe(s.clientX,s.clientY,frame_id);break;case"popup_message":B_E._.popup_message(s.message,s.period);break;case"close_iframe":window.removeEventListener("message",n,!1),a(),t(s.reason||"Closed"),$("div.wallet").remove();break;case"remove_wallet":document.cookie="BitcoinExpressWallet=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;",a(),window.removeEventListener("message",n,!1),$("iframe.wallet").remove();break;case"handle_failure":window.removeEventListener("message",n,!1),a(),$("iframe.wallet").remove();break;case"payment":if(!s.payment){t(new Error("System error"));break}var y=s.payment;void 0,$.ajax({url:i,data:JSON.stringify(y),type:"POST",accepts:{json:"application/json"},contentType:"application/json",dataType:"json",timeout:15e3,async:!0,success:function(t){var o=t.PaymentAck;if(void 0,!o)return e.source.postMessage({err:"PaymentAck undefined"},"*"),void window.removeEventListener("message",n,!1);if(!("id"in o&&o.id==y.Payment.id))return e.source.postMessage({err:"PaymentAck.id undefined or incorrect"},"*"),void window.removeEventListener("message",n,!1);if(!("return_url"in o))return e.source.postMessage({err:"PaymentAck.return_url undefined"},"*"),void window.removeEventListener("message",n,!1);var i=function(e){void 0;var t=e.data;"fn"in t&&"paymentAckAck"==t.fn&&window.removeEventListener("message",i,!1)};e.source.postMessage({fn:"paymentAck",ack:t},"*"),window.addEventListener("message",i,!1)},error:function(t,o,i){void 0,e.source.postMessage({err:i?i.message||i:"Payment function failed"},"*"),window.removeEventListener("message",n,!1)}})}};window.addEventListener("message",n,!1),window.addEventListener("resize",function(){o.isDraggable&&!o.isModal||B_E._.resize_iframe(frame_id,window.innerWidth,window.innerHeight)}),void 0})},resize_iframe:function(e,t,n){void 0;var o=$("#"+e);return o.length?(o.css({width:t,height:n}),!0):(void 0,!1)},start_drag_iframe:function(e,t,n){void 0;var o=document.getElementById(n).getBoundingClientRect();return this.x_elem=e,this.y_elem||(this.y_elem=t+o.top),this.dragging=!0,!1},show_iframe:function(e,t,n,o){void 0;var i=$("#"+e);if(i.length){if(!n)return i.css({left:-2e3,display:"hidden"}),!0;var s,r;if("string"==typeof o){void 0;var a=$("#"+o),l=a.offset();s=l.left+(a.innerWidth()-i.outerWidth())/2,r=l.top+(a.innerHeight()-i.outerHeight())/2}else if(null!==o&&"left"in o&&"top"in o)void 0,s=o.left,r=o.top;else{var c=this.get_window_size(),d=$(window);s=(c.width-i.outerWidth())/2+d.scrollLeft(),r=(c.height-i.outerHeight())/2+d.scrollTop(),s=s<5?5:s,r=r<5?5:r}return void 0,i.css({left:s,top:r,position:"absolute"}),i.css({display:"inherit"}),B_E.Wallet.WalletLastPosition={top:r,left:s},!0}return void 0,!1},move_iframe:function(e,t,n){$("#"+e).css({left:n,top:t,position:"absolute"})},get_window_size:function(){return{width:window.innerWidth||document.body.clientWidth||document.documentElement&&document.documentElement.clientWidth,height:window.innerHeight||document.body.clientHeight||document.documentElement&&document.documentElement.clientHeight}},popup_message:function(e,t){t=t||3e3,void 0;var n=$("<div/>",{id:"message-popup",class:"wallet-message-popup",style:"position:fixed; top:32px; right:32px; width:200px; z-index:100; border:solid 1px black; padding:8px; -moz-border-radius:5px; background-color:#ffffe0; display:none"});n.html(e),n.appendTo($("body")),n.fadeIn(),setTimeout(function(){n.fadeOut(function(){n.remove()})},t)},getPaymentRequest:function(e,t,n){return new Promise(function(o,i){"object"==typeof e?o({PaymentRequest:{payment_details_version:void 0===n?"1":n,PaymentDetails:e}}):null===t||void 0===t?i(new Error("Either Payment details or Payment url must be defined")):$.ajax({url:t,type:"GET",accepts:{json:"application/json"},contentType:"application/json",dataType:"json",timeout:3e4,async:!0,success:function(e){"PaymentRequest"in e?o(e):i(new error("PaymentRequest not found"))},error:function(e,t,n){void 0,i(new error("Payment function failed"))}})})},setWalletSelectorStyle:function(e){var t=$(e);t[0].style.width="252px",t[0].style.height="396px",t[0].style.boxShadow="0 0 10px 10px rgba(0, 0, 0, 0.1), 0 0 10px 10px rgba(0, 0, 0, 0.1)",t[0].style.textAlign="center",t[0].style.margin="20px",t[0].style.padding="10px",t[0].style.color="#fff",t[0].style["background-image"]="url('https://bitcoin-e.org/static/images/Bitcoin-express-trans.png')",t[0].style["background-repeat"]="no-repeat",t[0].style["background-position"]="center 120px",t[0].style.backgroundColor="#888",t[0].style.border="solid white 4px",t[0].style.borderRadius="40px 12px 40px 12px",t[0].style.position="absolute",t[0].style["z-index"]="20000";var n=this.get_window_size(),o=$(window),i=(n.width-t.outerWidth())/2+o.scrollLeft(),s=(n.height-t.outerHeight())/2+o.scrollTop();i=i<5?5:i,s=s<5?5:s,t[0].style.left=i+"px",t[0].style.top=s+"px"},buildWalletSelector:function(e){$("body").append("<div id='B_E_container' />"),B_E._.setWalletSelectorStyle("div#B_E_container");var t="width: 220px; margin: 5px auto; color: #efefef";$("div#B_E_container").append("<img id='logo_selector' src='https://bitcoin-e.org/wallet/css/img/BitcoinExpress.svg' style='margin: 10px; cursor: move;' />"),$("div#B_E_container").append("<p style='"+t+"'>Select your Wallet supplier:</p>"),$("div#B_E_container").append("<ul style='padding: 0 0 0 0' type='text' id='wallet-list'></ul>"),$("div#B_E_container").append("<p style='"+t+"'>- OR -</p>"),$("div#B_E_container").append("<p style='"+t+"'>Enter your Wallet's domain</p>"),$("div#B_E_container").append("<input id='user-domain' style='width: 168px; margin-top: 10px'/> <button name='ok'>OK</button>"),$("div#B_E_container").append("<br/><br/>"),$("div#B_E_container").append("<button name='cancel' style='margin-top: 20px; cursor: pointer;'>Cancel</button>")},getWalletDomain:function(e){var t=B_E._.getCookie("BitcoinExpressWallet");return t.length>0?Promise.resolve(t):new Promise(function(e,t){B_E._.buildWalletSelector("div#B_E_container"),$("#wallet-list").empty();var n=function(t){void 0;var o=t.data;if("fn"in o&&"probe"===o.fn){void 0;var i=$("<li style='list-style:none;color: #00357d;font-size:110%;cursor:pointer;text-transform: uppercase' data-origin='"+t.origin+"'>"+o.displayName+"</li>");$("#wallet-list").append(i),window.removeEventListener("message",n,!1),i.click(function(){!function(e,t,n){var o=new Date;o.setTime(o.getTime()+24*n*60*60*1e3);var i="expires="+o.toUTCString();document.cookie=e+"="+t+";"+i+";path=/"}("BitcoinExpressWallet",t.origin+o.walletName,30),$("div#B_E_container").remove(),e(t.origin+o.walletName)})}else void 0};$("div#B_E_container button[name='cancel']").click(function(e){window.removeEventListener("message",n,!1),$("div#B_E_container").remove()}),window.addEventListener("message",n,!1),$("div#B_E_container button[name='ok']").click(function(){var t=$("#user-domain").val();t.length>0?($("div#B_E_container").remove(),e("http://"+t+":8080/Bitcoin-express/Tests/bitcoin-express-wallet-app-mock.html")):void 0}),B_E.wellKnownWallets.forEach(function(e,t,n){var o=e.protocol+e.domain+e.port+e.path+e.probe;void 0,$("div#B_E_container").append("<iframe src='"+o+"' style='display : none'></iframe>")});var o=$("img#logo_selector");o.mousedown(function(e){if(o.index(e.target)>=0){var t=$("div#B_E_container").position();return B_E._.start_drag_iframe(e.screenX-t.left,e.screenY-t.top,"B_E_container"),!1}void 0})})},getCookie:function(e){for(var t=e+"=",n=document.cookie.split(";"),o=0;o<n.length;o++){for(var i=n[o];" "==i.charAt(0);)i=i.substring(1);if(0==i.indexOf(t))return i.substring(t.length,i.length)}return""},setCookie:function(e,t,n){var o=new Date;o.setTime(o.getTime()+24*n*60*60*1e3);var i="expires="+o.toUTCString();document.cookie=e+"="+t+";"+i+";path=/"},preventDefault:function(e){(e=e||window.event).preventDefault&&e.preventDefault(),e.returnValue=!1},preventDefaultForScrollKeys:function(e){if({37:1,38:1,39:1,40:1}[e.keyCode])return B_E._.preventDefault(e),!1}},Host:{Initialise:function(){window.B_E||(window.B_E=window.BitcoinExpress,void 0)},WalletReveal:function(e,t,n,o){return void 0,void 0!==BitcoinExpress.Host?(this.sendMessage({fn:"resize_iframe",width:t,height:n}),this.sendMessage({fn:"show_iframe"}),o&&this.WalletMakeDraggable(o),B_E.Wallet.Dimentions.WalletWidth=t,B_E.Wallet.Dimentions.WalletHeight=n,B_E.Wallet.Dimentions.WalletArea=$("#"+e),Promise.resolve("OK")):Promise.reject(new Error("Host not found"))},WalletGoModal:function(e,t,n,o){void 0;var i=this;return new Promise(function(s,r){if(BitcoinExpress.Host){var a={fn:"gomodal_iframe",width:t,height:n,goModal:e};if(o){a.walletId=o;var l=function(e){void 0;var t=e.data;if("string"==typeof t&&(t=JSON.parse(e.data)),"fn"in t&&"relocateWallet"==t.fn)return $("#"+t.walletId).css({left:t.left,top:t.top,position:"absolute"}),setTimeout(function(){$("#"+t.walletId).fadeIn("fast")},600),window.removeEventListener("message",l,!1),void s("OK");r("err"in t?t.err:Error("Problem on processing payment"))};window.addEventListener("message",l,!1),i.sendMessage(a)}else i.sendMessage(a),s("OK")}else r(Error("Bitcoin-express not initialised"))})},WalletClose:function(e,t){return void 0,BitcoinExpress.Host?(this.sendMessage({fn:"popup_message",message:e,period:4e3}),this.sendMessage({fn:"handle_failure",reason:t}),Promise.resolve("OK")):Promise.reject(new Error("Host not found"))},WalletRemove:function(e,t){return void 0,BitcoinExpress.Host?(this.sendMessage({fn:"popup_message",message:e,period:4e3}),this.sendMessage({fn:"remove_wallet",reason:t}),Promise.resolve("OK")):Promise.reject(new Error("Host not found"))},WalletFullScreen:function(e){if(void 0,!BitcoinExpress.Host)return Promise.reject(new Error("Host not found"));if(e){this.sendMessage({fn:"disable_scroll",hide:!0},"*");var t=this;setTimeout(function(){t.sendMessage({fn:"resize_iframe",fullScreen:!0}),document.getElementsByTagName("body")[0].style.visibility="inherit"},500)}else this.sendMessage({fn:"enable_scroll"},"*"),this.sendMessage({fn:"resize_iframe",width:B_E.Wallet.Dimentions.WalletWidth,height:BitcoinExpress.Wallet.Dimentions.WalletHeight,fullScreen:!1});return Promise.resolve("OK")},WalletMakeDraggable:function(e){if(void 0,e="string"==typeof e?$("#"+e):e||$("body"),void 0!==BitcoinExpress.Host){var t=this;return e.mousedown(function(n){if(e.index(n.target)>=0){t.activeDraggable||(!function(e){var n=window.document.onmousemove,o=window.document.onmouseup;window.document.onmousemove=function(o){n&&n(o),t.sendMessage({fn:"bubble_up_mousemove",frameId:e,detail:o.detail,screenX:o.screenX,screenY:o.screenY,clientX:o.clientX,clientY:o.clientY,ctrlKey:o.ctrlKey,altKey:o.altKey,shiftKey:o.shiftKey,metaKey:o.metaKey,button:o.button})},window.document.onmouseup=function(n){o&&o(n),t.sendMessage({fn:"bubble_up_mouseup",frameId:e,detail:n.detail,screenX:n.screenX,screenY:n.screenY,clientX:n.clientX,clientY:n.clientY,ctrlKey:n.ctrlKey,altKey:n.altKey,shiftKey:n.shiftKey,metaKey:n.metaKey,button:n.button})}}(frame_id),t.activeDraggable=!0);return t.sendMessage({fn:"start_drag_iframe",clientX:n.clientX,clientY:n.clientY}),!1}void 0}),Promise.resolve("OK")}return Promise.reject(new Error("Host not found"))},Payment:function(e,t){void 0;var n=this;return new Promise(function(t,o){if(BitcoinExpress.Host){var i=function(e){void 0;var n=e.data;"string"==typeof n&&(n=JSON.parse(e.data)),window.removeEventListener("message",i,!1),"fn"in n&&"paymentAck"==n.fn?t(n.ack):o("err"in n?n.err:Error("Problem on processing payment"))};window.addEventListener("message",i,!1),n.sendMessage({fn:"payment",payment:e})}else o(Error("Bitcoin-express not initialised"))})},PaymentAckAck:function(){return void 0,void 0!==BitcoinExpress.Host?(B_E.Host.sendMessage({fn:"paymentAckAck"}),Promise.resolve("OK")):Promise.reject(new Error("Bitcoin-express not initialised"))},PopupMessage:function(e,t){return void 0,void 0!==BitcoinExpress.Host?(this.sendMessage({fn:"popup_message",message:e,period:t}),Promise.resolve("OK")):Promise.reject(new Error("Bitcoin-express not initialised"))},sendMessage:function(e){parent.postMessage(e,"*")}}};