var frame_id="walletxyz",BitcoinExpress={BitcoinExpress:"v1.0.0",wellKnownWallets:JSON.parse('[{"domain":"bitcoin-e.org","protocol":"https://","port":":443","path":"","probe":"/wallet/probe.html","wallet":"/wallet/wallet.html"}]'),Initialise:function(){void 0,"B_E"in window?($("div#B_E_container").remove(),$("iframe.wallet").remove()):(window.B_E=window.BitcoinExpress,void 0)},Wallet:{Dimentions:{WalletWindow:null,WalletWidth:null,WalletHeight:null,WalletArea:null,WalletLastPosition:{top:0,left:0}},Open:function(e){return e||(e={}),BitcoinExpress.Initialise(),B_E._.getWalletDomain().then(function(n){return B_E._.startWallet(n,e)})},PaymentRequest:function(e,n,t){return BitcoinExpress.Initialise(),B_E._.getPaymentRequest(e,n,t).then(function(e){return B_E._.getWalletDomain()}).then(function(e){return B_E._.startWallet(e,paymentRequest)})}},_:{startWallet:function(e,n){void 0,$("body").append("<div id='B_E_container'/>");var t=e;this.isDraggable=!1,this.activeDraggable=!1,this.isModal=!1,this.frame_id=frame_id;var o=this;t+="?fullScreen="+("fullScreen"in n&&n.fullScreen);var i=null;if("PaymentRequest"in n){var a=n.PaymentRequest;if(t+="&paymentRequest="+encodeURI(JSON.stringify(n.PaymentRequest)),"PaymentDetails"in a&&"payment_url"in a.PaymentDetails&&(i=a.PaymentDetails.payment_url),null===i)return Promise.reject(new Error("PaymentRequest has no payment_url"))}return $("<iframe>",{src:t,id:"walletxyz",class:"wallet",frameborder:0,scrolling:"no",style:"z-index: 10000000; display: hidden;"}).appendTo("body"),new Promise(function(e,n){var t=function(e){void 0;var a=e.data;switch(void 0,a.fn){case"show_iframe":B_E._.show_iframe(frame_id,null,!0,null);break;case"hide_iframe":B_E._.show_iframe(frame_id,null,!1,null);break;case"gomodal_iframe":if(o.isModal=a.goModal,a.goModal){var l=B_E.Wallet.WalletLastPosition||{left:0,top:0},s=document.documentElement,r=(window.pageXOffset||s.scrollLeft)-(s.clientLeft||0),d=(window.pageYOffset||s.scrollTop)-(s.clientTop||0);B_E._.resize_iframe(frame_id,window.innerWidth,window.innerHeight),B_E._.move_iframe(frame_id,d,r),o.isDraggable&&disableScroll(!1)}else{l=B_E.Wallet.WalletLastPosition||{left:0,top:0};B_E._.resize_iframe(frame_id,a.width,a.height),B_E._.move_iframe(frame_id,l.top,l.left),o.isDraggable&&enableScroll()}break;case"resize_iframe":if(a.fullScreen){o.isDraggable=!1;var c=o.get_window_size();B_E._.resize_iframe(frame_id,c.width,c.height);s=document.documentElement,r=(window.pageXOffset||s.scrollLeft)-(s.clientLeft||0),d=(window.pageYOffset||s.scrollTop)-(s.clientTop||0);B_E._.move_iframe(frame_id,d,r)}else{o.isDraggable=!0,B_E._.resize_iframe(frame_id,a.width,a.height);(l=B_E.Wallet.WalletLastPosition)&&"top"in l&&"left"in l&&B_E._.move_iframe(frame_id,l.top,l.left)}break;case"start_drag_iframe":if(!o.isDraggable)break;B_E._.start_drag_iframe(a.clientX||a.pageX,a.clientY||a.pageY,frame_id);break;case"popup_message":B_E._.popup_message(a.message,a.period);break;case"close_iframe":window.removeEventListener("message",t,!1),enableScroll(),n(a.reason||"Closed"),$("div.wallet").remove();break;case"remove_wallet":document.cookie="BitcoinExpressWallet=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;",enableScroll(),window.removeEventListener("message",t,!1),$("iframe.wallet").remove();break;case"handle_failure":window.removeEventListener("message",t,!1),enableScroll(),$("iframe.wallet").remove();break;case"payment":"payment"in a||n(new Error("System error"));var m=a.payment;void 0,$.ajax({url:i,data:JSON.stringify(m),type:"POST",accepts:{json:"application/json"},contentType:"application/json",dataType:"json",timeout:15e3,async:!0,success:function(n){if(void 0,"PaymentAck"in n){var o=n.PaymentAck;if("id"in o&&o.id==m.Payment.id)if("return_url"in o){var i=function(e){void 0;var n=e.data;"fn"in n&&"paymentAckAck"==n.fn&&window.removeEventListener("message",i,!1)};e.source.postMessage({fn:"paymentAck",ack:n},"*"),window.addEventListener("message",i,!1)}else e.source.postMessage({err:"PaymentAck.return_url undefined"},"*"),window.removeEventListener("message",t,!1);else e.source.postMessage({err:"PaymentAck.id undefined or incorrect"},"*"),window.removeEventListener("message",t,!1)}else e.source.postMessage({err:"PaymentAck undefined"},"*"),window.removeEventListener("message",t,!1)},error:function(n,o,i){void 0,e.source.postMessage({err:i?i.message||i:"Payment function failed"},"*"),window.removeEventListener("message",t,!1)}})}};window.addEventListener("message",t,!1),window.addEventListener("resize",function(){o.isDraggable&&!o.isModal||B_E._.resize_iframe(frame_id,window.innerWidth,window.innerHeight)}),void 0})},resize_iframe:function(e,n,t){void 0;var o=$("#"+e);return o.length?(o.css({width:n,height:t}),!0):(void 0,!1)},start_drag_iframe:function(e,n,t){void 0;var o=document.documentElement,i=(window.pageXOffset||o.scrollLeft)-(o.clientLeft||0),a=(window.pageYOffset||o.scrollTop)-(o.clientTop||0),l=document.getElementById(t),s=0,r=0;return document.onmousemove=function(t){s=document.all?window.event.clientX:t.pageX,r=document.all?window.event.clientY:t.pageY,null!==l&&(s>$(window).width()?l.style.left=s-e+"px":l.style.left=s+i-e+"px",r>$(window).height()?l.style.top=r-n+"px":l.style.top=r+a-n+"px")},document.onmouseup=function(){l&&(B_E.Wallet.WalletLastPosition={top:l.offsetTop,left:l.offsetLeft},document.onmousemove=null,document.onmouseup=null,l=null)},!1},show_iframe:function(e,n,t,o){void 0;var i=$("#"+e);if(i.length){if(!t)return i.css({left:-2e3,display:"hidden"}),!0;var a,l;if("string"==typeof o){void 0;var s=$("#"+o),r=s.offset();a=r.left+(s.innerWidth()-i.outerWidth())/2,l=r.top+(s.innerHeight()-i.outerHeight())/2}else if(null!==o&&"left"in o&&"top"in o)void 0,a=o.left,l=o.top;else{var d=this.get_window_size(),c=$(window);a=(d.width-i.outerWidth())/2+c.scrollLeft(),l=(d.height-i.outerHeight())/2+c.scrollTop(),a=a<5?5:a,l=l<5?5:l}return void 0,i.css({left:a,top:l,position:"absolute"}),i.css({display:"inherit"}),B_E.Wallet.WalletLastPosition={top:l,left:a},!0}return void 0,!1},move_iframe:function(e,n,t){$("#"+e).css({left:t,top:n,position:"absolute"})},get_window_size:function(){return{width:window.innerWidth||document.body.clientWidth||document.documentElement&&document.documentElement.clientWidth,height:window.innerHeight||document.body.clientHeight||document.documentElement&&document.documentElement.clientHeight}},popup_message:function(e,n){n=n||3e3,void 0;var t=$("<div/>",{id:"message-popup",class:"wallet-message-popup",style:"position:fixed; top:32px; right:32px; width:200px; z-index:100; border:solid 1px black; padding:8px; -moz-border-radius:5px; background-color:#ffffe0; display:none"});t.html(e),t.appendTo($("body")),t.fadeIn(),setTimeout(function(){t.fadeOut(function(){t.remove()})},n)},getPaymentRequest:function(e,n,t){return new Promise(function(o,i){"object"==typeof e?o({PaymentRequest:{payment_details_version:void 0===t?"1":t,PaymentDetails:e}}):null===n||void 0===n?i(new error("Either Payment details or Payment url must be defined")):$.ajax({url:n,type:"GET",accepts:{json:"application/json"},contentType:"application/json",dataType:"json",timeout:3e4,async:!0,success:function(e){"PaymentRequest"in e?o(e):i(new error("PaymentRequest not found"))},error:function(e,n,t){void 0,i(new error("Payment function failed"))}})})},setWalletSelectorStyle:function(e){var n=$(e);n[0].style.width="252px",n[0].style.height="396px",n[0].style.boxShadow="0 0 10px 10px rgba(0, 0, 0, 0.1), 0 0 10px 10px rgba(0, 0, 0, 0.1)",n[0].style.textAlign="center",n[0].style.margin="20px",n[0].style.padding="10px",n[0].style.color="#fff",n[0].style.backgroundColor="#888",n[0].style.border="solid white 4px",n[0].style.borderRadius="40px 12px 40px 12px",n[0].style.position="absolute",n[0].style["z-index"]="20000";var t=this.get_window_size(),o=$(window),i=(t.width-n.outerWidth())/2+o.scrollLeft(),a=(t.height-n.outerHeight())/2+o.scrollTop();i=i<5?5:i,a=a<5?5:a,n[0].style.left=i+"px",n[0].style.top=a+"px"},buildWalletSelector:function(e){$("body").append("<div id='B_E_container' />"),B_E._.setWalletSelectorStyle("div#B_E_container"),$("div#B_E_container").append("<img id='logo_selector' src='https://bitcoin-e.org/wallet/css/img/BitcoinExpress.svg' style='margin: 10px; cursor: move;' />"),$("div#B_E_container").append("<p style='width:220px;margin-left:auto;margin-right:auto;color:#efefef;'>Please enter your Wallet's domain</p>"),$("div#B_E_container").append("<input id='user-domain' style='width:168px'/> <button name='ok'>OK</button><br/>"),$("div#B_E_container").append("<p style='width:220px;margin: 20px auto 0 auto;color:#efefef;'>OR - select one from the list below:</p>"),$("div#B_E_container").append("<ul style='padding:0 0 0 0' type='text' id='wallet-list'></ul>"),$("div#B_E_container").append("<button name='cancel' style='margin-top: 20px;'>Cancel</button>"),$("div#B_E_container").append("<h4 style='font-size: 30px;opacity:0.2;margin-top: 20px'>wallet loader</h4>")},getWalletDomain:function(e){return new Promise(function(e,n){var t=B_E._.getCookie("BitcoinExpressWallet");if(t.length>0)e(t);else{B_E._.buildWalletSelector("div#B_E_container");var o=function(n){void 0;var t=n.data;if("fn"in t&&"probe"===t.fn){void 0;var i=$("<li style='list-style:none;color: #00357d;font-size:120%;cursor:pointer' data-origin='"+n.origin+"'>"+t.displayName+"</li>");$("#wallet-list").append(i),i.click(function(){!function(e,n,t){var o=new Date;o.setTime(o.getTime()+24*t*60*60*1e3);var i="expires="+o.toUTCString();document.cookie=e+"="+n+";"+i+";path=/"}("BitcoinExpressWallet",n.origin+t.walletName,30),window.removeEventListener("message",o,!1),$("div#B_E_container").remove(),e(n.origin+t.walletName)})}else void 0};$("div#B_E_container button[name='cancel']").click(function(e){window.removeEventListener("message",o,!1),$("div#B_E_container").remove()}),window.addEventListener("message",o,!1),$("div#B_E_container button[name='ok']").click(function(){var n=$("#user-domain").val();n.length>0?($("div#B_E_container").remove(),e("http://"+n+":8080/Bitcoin-express/Tests/bitcoin-express-wallet-app-mock.html")):void 0}),B_E.wellKnownWallets.forEach(function(e,n,t){var o=e.protocol+e.domain+e.port+e.path+e.probe;void 0,$("div#B_E_container").append("<iframe src='"+o+"' style='display : none'></iframe>")});var i=$("div#B_E_container");i.mousedown(function(e){if(i.index(e.target)>=0)return B_E._.start_drag_iframe(e.clientX,e.clientY,"B_E_container"),!1;void 0})}})},getCookie:function(e){for(var n=e+"=",t=document.cookie.split(";"),o=0;o<t.length;o++){for(var i=t[o];" "==i.charAt(0);)i=i.substring(1);if(0==i.indexOf(n))return i.substring(n.length,i.length)}return""},setCookie:function(e,n,t){var o=new Date;o.setTime(o.getTime()+24*t*60*60*1e3);var i="expires="+o.toUTCString();document.cookie=e+"="+n+";"+i+";path=/"}},Host:{Initialise:function(){"B_E"in window||(window.B_E=window.BitcoinExpress,void 0)},WalletReveal:function(e,n,t,o){void 0;var i=this;return new Promise(function(a,l){void 0!==BitcoinExpress.Host?(i.sendMessage({fn:"resize_iframe",width:n,height:t}),i.sendMessage({fn:"show_iframe"}),o&&i.WalletMakeDraggable(o),B_E.Wallet.Dimentions.WalletWidth=n,B_E.Wallet.Dimentions.WalletHeight=t,B_E.Wallet.Dimentions.WalletArea=$("#"+e),a("OK")):l(new Error("Host not found"))})},WalletGoModal:function(e,n,t){void 0,this.sendMessage({fn:"gomodal_iframe",width:n,height:t,goModal:e})},WalletClose:function(e,n){void 0;var t=this;return new Promise(function(o,i){void 0!==BitcoinExpress.Host?(t.sendMessage({fn:"popup_message",message:e,period:4e3}),t.sendMessage({fn:"handle_failure",reason:n}),o("OK")):i(new Error("Host not found"))})},WalletRemove:function(e,n){void 0;var t=this;return new Promise(function(o,i){void 0!==BitcoinExpress.Host?(t.sendMessage({fn:"popup_message",message:e,period:4e3}),t.sendMessage({fn:"remove_wallet",reason:n}),o("OK")):i(new Error("Host not found"))})},WalletFullScreen:function(e){void 0;var n=this;return new Promise(function(t,o){void 0!==BitcoinExpress.Host?(e?(disableScroll(),setTimeout(function(){n.sendMessage({fn:"resize_iframe",fullScreen:!0}),document.getElementsByTagName("body")[0].style.visibility="inherit"},500)):(enableScroll(),n.sendMessage({fn:"resize_iframe",width:B_E.Wallet.Dimentions.WalletWidth,height:BitcoinExpress.Wallet.Dimentions.WalletHeight,fullScreen:!1})),t("OK")):o(new Error("Host not found"))})},WalletMakeDraggable:function(e){void 0,e=e?$("#"+e):e||$("body");var n=this;return new Promise(function(t,o){void 0!==BitcoinExpress.Host?(e.mousedown(function(t){if(e.index(t.target)>=0){this.activeDraggable||(!function(e){var n=window.document.onmousemove,t=window.document.onmouseup;window.document.onmousemove=function(t){n&&n(t);var o=document.createEvent("MouseEvents"),i=e.getBoundingClientRect();o.initMouseEvent("mousemove",!0,!1,window,t.detail,t.screenX,t.screenY,t.clientX+i.left,t.clientY+i.top,t.ctrlKey,t.altKey,t.shiftKey,t.metaKey,t.button,null),e.dispatchEvent(o)},window.document.onmouseup=function(n){t&&t(n);var o=document.createEvent("MouseEvents"),i=e.getBoundingClientRect();o.initMouseEvent("mouseup",!0,!1,window,n.detail,n.screenX,n.screenY,n.clientX+i.left,n.clientY+i.top,n.ctrlKey,n.altKey,n.shiftKey,n.metaKey,n.button,null),e.dispatchEvent(o)}}(window.parent.document.getElementById(frame_id)),this.activeDraggable=!0);return n.sendMessage({fn:"start_drag_iframe",clientX:t.clientX,clientY:t.clientY}),!1}void 0}),t("OK")):o(new Error("Host not found"))})},Payment:function(e,n){void 0;var t=this;return new Promise(function(n,o){if(void 0!==BitcoinExpress.Host){var i=function(e){void 0;var t=e.data;"string"==typeof e.data&&(t=JSON.parse(e.data));var a=t;window.removeEventListener("message",i,!1),"fn"in a&&"paymentAck"==a.fn?n(a.ack):o("err"in a?a.err:Error("Problem on processing payment"))};window.addEventListener("message",i,!1),t.sendMessage({fn:"payment",payment:e})}else o(Error("Bitcoin-express not initialised"))})},PaymentAckAck:function(){void 0;return new Promise(function(e,n){void 0!==BitcoinExpress.Host?(B_E.Host.sendMessage({fn:"paymentAckAck"}),e("OK")):n(new Error("Bitcoin-express not initialised"))})},PopupMessage:function(e,n){void 0;var t=this;return new Promise(function(o,i){void 0!==BitcoinExpress.Host?(t.sendMessage({fn:"popup_message",message:e,period:n}),o("OK")):i(new Error("Bitcoin-express not initialised"))})},sendMessage:function(e){void 0,parent.postMessage(e,"*")}}};function preventDefault(e){(e=e||window.parent.event).preventDefault&&e.preventDefault(),e.returnValue=!1}function preventDefaultForScrollKeys(e){if({37:1,38:1,39:1,40:1}[e.keyCode])return preventDefault(e),!1}function disableScroll(e){void 0==e&&(e=!0),window.parent.addEventListener&&window.parent.addEventListener("DOMMouseScroll",preventDefault,!1),window.parent.onwheel=preventDefault,window.parent.onmousewheel=window.parent.document.onmousewheel=preventDefault,window.parent.ontouchmove=preventDefault,window.parent.document.onkeydown=preventDefaultForScrollKeys,window.parent.document.getElementsByTagName("body")[0].style.overflow="hidden",e&&(document.getElementsByTagName("body")[0].style.visibility="hidden")}function enableScroll(){window.removeEventListener&&window.parent.removeEventListener("DOMMouseScroll",preventDefault,!1),window.parent.onmousewheel=window.parent.document.onmousewheel=null,window.parent.onwheel=null,window.parent.ontouchmove=null,window.parent.document.onkeydown=null,window.parent.document.getElementsByTagName("body")[0].style.overflow="scroll"}